#ifndef LANEDETECTION_LATERAL_CONTROL_WEBOTS_H_
#define LANEDETECTION_LATERAL_CONTROL_WEBOTS_H_

#include <Eigen/Eigen>
#include "lkas_model.hpp"
#include "config_webots.hpp"

#define MAX_SCENARIOS 12 //!< maximum number of scenarios defined
#define LENGTH_PHI_AUG 6 //!< length of the phi_aug matrix of the controller. 
/// @brief Class for lateral controller in Webots
class lateralControllerWEBOTS : lkasModel {
private:
    /// member variables
    std::vector<long double> m_input = std::vector<long double> (40000);
    long double m_desired_steering_angle;
    /// Controller matrices. Note that the Matrix dimensions need to be changed depending on the type of controller and controller implementation choice.
    std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, LENGTH_PHI_AUG> > m_phi_aug
                                        = std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, LENGTH_PHI_AUG> > (MAX_SCENARIOS);
    std::vector< Eigen::Matrix<long double, 1, LENGTH_PHI_AUG> > m_K2c
                                        = std::vector< Eigen::Matrix<long double, 1, LENGTH_PHI_AUG> > (MAX_SCENARIOS);
    std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, 1> > m_Gamma_aug
                                        = std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, 1> > (MAX_SCENARIOS);
public:
    // class public methods
    void compute_steering_angle(long double the_yL, int the_it_counter,int scenario);
    long double get_steering_angle();
    void estimate_next_state(int the_it_counter,int scenario);
    vector<float> period_ms, tau_ms;
    /// constructor
    lateralControllerWEBOTS(int vel) : lkasModel(1.628L, 2.995L, (vel*5/18), 5.5L, 1.2975L) {
            m_desired_steering_angle = 0.0L;
            fill(m_input.begin(), m_input.end(), 0.0L); // m_input is the input of the last sampling period.

            period_ms={45.f, 25.f, 25.f, 45.f, 25.f, 25.f, 25.f, 25.f, 40.f, 25.f, 35.f, 40.f}; //!< sampling period h in ms for each scenario s_i
            tau_ms={45.f, 25.f, 25.f, 45.f, 25.f, 25.f, 25.f, 25.f, 40.f, 25.f, 35.f, 40.f}; //!< sensor-to-actuator delay \tau in ms for each scenario s_i
	    if (period_ms.size() != tau_ms.size())
		throw range_error("In lateralControllerWEBOTS, size of vectors period_ms and tau_ms should be the same");
            /////////////////////////////////////////////////////////////// v0 ////////////////////////////////////////////////////////////////////////////
                m_phi_aug[0] <<
            0.52883986941906702,   -0.29038154325852811,   0,   0,   0,   1.7386917275101677,
                 -0.023535441051300791,   0.63314467835974142,   0,   0,   0,   1.1205892255645273,
                 -0.029602119818158964,   -0.19770419532932151,   1,   0.375,   0.0703125,   -0.19982701874114689,
                 0.00064166535162837207,   -0.036062865234988119,   0,   1,   0.375,   -0.027427760169868778,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

                m_K2c[0] <<
            -0.0087759137743595728,   -0.13960481778763009,   0.20308410600045956,   0.79301628412805103,   3.2822753403311005e-15,   -0.21642718567871738; // Q = 7.5, R=200
            // -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
            // -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
            //-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5

                m_Gamma_aug[0] <<
            0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// v1 ////////////////////////////////////////////////////////////////////////////
                m_phi_aug[1] <<
            0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
                 -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
                 -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
                 0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

            // // v1 q=7.5
                m_K2c[1] <<
            -0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
            //-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5

                m_Gamma_aug[1] <<
              0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// v2 ////////////////////////////////////////////////////////////////////////////
              m_phi_aug[3] <<
            0.52883986941906702,   -0.29038154325852811,   0,   0,   0,   1.7386917275101677,
                 -0.023535441051300791,   0.63314467835974142,   0,   0,   0,   1.1205892255645273,
                 -0.029602119818158964,   -0.19770419532932151,   1,   0.375,   0.0703125,   -0.19982701874114689,
                 0.00064166535162837207,   -0.036062865234988119,   0,   1,   0.375,   -0.027427760169868778,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

                m_K2c[3] <<
            -0.0087759137743595728,   -0.13960481778763009,   0.20308410600045956,   0.79301628412805103,   3.2822753403311005e-15,   -0.21642718567871738; // Q = 7.5, R=200
            // -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
            // -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
            //-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5

                m_Gamma_aug[3] <<
            0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// v3 ////////////////////////////////////////////////////////////////////////////
                m_phi_aug[3] <<
            0.52883986806157912,   -0.29038154205146549,   0,   0,   0,   1.490626892021268,
                 -0.023535441093393623,   0.63314467718880141,   0,   0,   0,   0.98529260456011958,
                 -0.02960211977081793,   -0.19770419515258555,   1,   0.37499999849999993,   0.070312499437499995,   -0.19765847703130213,
                 0.00064166535329202902,   -0.036062865204078136,   0,   1,   0.37499999849999999,   -0.027132986534157869,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;


                // q=7.5
                m_K2c[3] <<
            -0.0085833529640744061,   -0.13588107905249372,   0.19723754451439496,   0.77794040475457726,   1.0943616212619361e-15,   -0.19130406236218295; // Q = 7.5
            //-0.29249027996323107,   -0.28549560532646351,   -1.056563344205941,   0.079929179840173781,   -0.18633734617443931; // Q = 2.5

                m_Gamma_aug[3] <<
            0.24806483404500307,
                 0.13529661991111691,
                 -0.0021685415692104075,
                 -0.00029477361775414343,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// v4 ////////////////////////////////////////////////////////////////////////////
                m_phi_aug[4] <<
            0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
                 -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
                 -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
                 0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

            // // v1 q=7.5
                m_K2c[4] <<
            -0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
            //-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5

                m_Gamma_aug[4] <<
              0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// v5 ////////////////////////////////////////////////////////////////////////////
             m_phi_aug[5] <<
            0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
                 -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
                 -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
                 0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

            // // v1 q=7.5
                m_K2c[5] <<
            -0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
            //-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5

                m_Gamma_aug[5] <<
              0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// v6 ////////////////////////////////////////////////////////////////////////////
                m_phi_aug[6] <<
            0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
                 -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
                 -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
                 0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

            // // v1 q=7.5
                m_K2c[6] <<
            -0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
            //-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5

                m_Gamma_aug[6] <<
              0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// v7 ////////////////////////////////////////////////////////////////////////////
            m_phi_aug[7] <<
            0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
                 -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
                 -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
                 0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

            // // v1 q=7.5
                m_K2c[7] <<
            -0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
            //-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5

                m_Gamma_aug[7] <<
              0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// v8 ////////////////////////////////////////////////////////////////////////////
                m_phi_aug[8] <<
            0.56698856654140162,   -0.27433108361455039,   0,   0,   0,   1.6198035123738834,
                 -0.022234550359150965,   0.665528063720906,   0,   0,   0,   1.0231332751670421,
                 -0.027517940171709075,   -0.17982892253316662,   1,   0.33333333333333337,   0.055555555555555566,   -0.16090650342033347,
                 0.00052714004699310195,   -0.03281691348572887,   0,   1,   0.33333333333333337,   -0.022066123084759325,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

                // q=7.5
                m_K2c[8] <<
            -0.0099086967229825712,   -0.14093836446392632,   0.2133815240076401,   0.79886816083652101,   6.4324137571467438e-15,   -0.19715482623597491; // Q = 7.5
            //-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5

                m_Gamma_aug[8] <<
            0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// no classifier ////////////////////////////////////////////////////////////////////////////
            m_phi_aug[9] <<
            0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
                 -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
                 -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
                 0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

            // // v1 q=7.5
                m_K2c[9] <<
            -0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
            //-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5

                m_Gamma_aug[9] <<
              0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// 1 classifier ////////////////////////////////////////////////////////////////////////////
                m_phi_aug[10] <<
            0.60806805654952334,   -0.25514844806760095,   0,   0,   0,   1.4862100260130235,
                 -0.020679796627017692,   0.69971716698732711,   0,   0,   0,   0.91990185300303984,
                 -0.025191951682377599,   -0.16108926163927895,   1,   0.29166666666666669,   0.042534722222222245,   -0.1255882807656688,
                 0.000419742819967695,   -0.029404575461172356,   0,   1,   0.29166666666666674,   -0.017206051800215522,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

                // q=7.5
                m_K2c[10] <<
            -0.011167119216029045,   -0.14191729279390985,   0.22410668326466493,   0.80365399906255219,   1.0346817860725014e-14,   -0.17665087187627446; // Q = 7.5
            //-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5

                m_Gamma_aug[10] <<
            0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

            /////////////////////////////////////////////////////////////// 2 classifier ////////////////////////////////////////////////////////////////////////////
                m_phi_aug[11] <<
            0.56698856654140162,   -0.27433108361455039,   0,   0,   0,   1.6198035123738834,
                 -0.022234550359150965,   0.665528063720906,   0,   0,   0,   1.0231332751670421,
                 -0.027517940171709075,   -0.17982892253316662,   1,   0.33333333333333337,   0.055555555555555566,   -0.16090650342033347,
                 0.00052714004699310195,   -0.03281691348572887,   0,   1,   0.33333333333333337,   -0.022066123084759325,
                 0,   0,   0,   0,   1,   0,
                 0,   0,   0,   0,   0,   0;

                // q=7.5
                m_K2c[11] <<
            -0.0099086967229825712,   -0.14093836446392632,   0.2133815240076401,   0.79886816083652101,   6.4324137571467438e-15,   -0.19715482623597491; // Q = 7.5
            //-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5

                m_Gamma_aug[11] <<
            0,
                 0,
                 -0,
                 -0,
                 0,
                 1;

    }
    // destructor
    ~lateralControllerWEBOTS(){
    }
};

#endif
